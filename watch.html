<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CTU — Watch</title>
<style>
  html,body{height:100%;margin:0;background:#050505;color:#fff;font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Helvetica, Arial;}
  .wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:10px;box-sizing:border-box;text-align:center;}
  .date{font-size:18px;font-weight:600;margin-bottom:6px;}
  .time{font-family:monospace;font-size:30px;font-weight:700;}
  .btns{position:absolute;right:8px;top:8px;display:flex;flex-direction:column;gap:8px;}
  button{background:rgba(255,255,255,0.08);border:0;padding:8px;border-radius:10px;color:#fff;font-size:14px;}
  small{opacity:0.6}
</style>
</head>
<body>
  <div class="wrap">
    <div class="date" id="ctu-date">— — —</div>
    <div class="time" id="ctu-time">--:--:-- CTU</div>
    <div style="margin-top:8px"><small id="mark">CTU</small></div>
  </div>

  <div class="btns">
    <button id="btn1">Ouvrir site</button>
    <button id="btn2">Action</button>
  </div>

<script>
// ---- CTU logic (portage minimal du repo) ----
const ORIGIN_UEC = 1486102.5;
const LUNITIONS = ["Nuiron","Kelva","Drenae","Vellune","Rokel","Cereon","Elvora","Zailun","Aruel","Thylis","Velunor","Ombran","Siliane"];
const NUIRON_DURATION = 11;
const LUNITION_DURATION = 29;
const SPINION_DURATION = 86400;

function mod(a,n){ let r = a % n; return r < 0 ? r + n : r; }
function toJulian(d){ return d.getTime()/86400000 - (d.getTimezoneOffset()/1440) + 2440587.5; }

function elapsedDaysToSpinionLunitionOrbion(elapsedDays){
  let orbion = (elapsedDays / 365.2422);
  let spinionOfOrbion = mod(elapsedDays, 365.2422);
  let lunition, spinion;
  if (Math.abs(orbion) < 1e-12 && Math.abs(spinionOfOrbion) < 1e-12) {
    lunition = 1; spinion = 1;
  } else {
    if (orbion > 0) {
      if (spinionOfOrbion < NUIRON_DURATION) {
        lunition = 0; spinion = spinionOfOrbion;
      } else {
        spinionOfOrbion -= NUIRON_DURATION;
        lunition = (spinionOfOrbion / LUNITION_DURATION) + 1;
        spinion = spinionOfOrbion % LUNITION_DURATION;
      }
    } else {
      lunition = (spinionOfOrbion / LUNITION_DURATION) + 1;
      spinion = spinionOfOrbion % LUNITION_DURATION;
    }
    if (spinion === 0) spinion = 0; else spinion += 1;
  }
  spinion = Math.floor(spinion);
  lunition = Math.floor(lunition % 13);
  orbion = Math.floor(orbion);
  return { spinion, lunition, orbion };
}

function computeCTU(date){
  const jd = toJulian(date);
  const elapsedDays = jd - ORIGIN_UEC;
  const elapsedSeconds = elapsedDays * SPINION_DURATION;
  const {spinion, lunition, orbion} = elapsedDaysToSpinionLunitionOrbion(elapsedDays);
  const secondsToSpinion = mod(elapsedSeconds, SPINION_DURATION);
  const fraction = secondsToSpinion / SPINION_DURATION;
  const spinor = Math.floor(fraction * 20);
  const minor = Math.floor((fraction * 2000) % 100);
  const secor = Math.floor((fraction * 200000) % 100);
  return { spinion, lunition, orbion, spinor, minor, secor, secondsIntoSpinion: secondsToSpinion };
}

// ---- UI update ----
const elDate = document.getElementById('ctu-date');
const elTime = document.getElementById('ctu-time');
let tickHandle = null;

function renderOnce(){
  const now = new Date();
  const s = computeCTU(now);
  elDate.textContent = `${s.spinion} ${LUNITIONS[s.lunition]} ${s.orbion}`;
  elTime.textContent = `${String(s.spinor).padStart(2,'0')}:${String(s.minor).padStart(2,'0')}:${String(s.secor).padStart(2,'0')} CTU`;
}

// start/stop 1s updates based on visibility
function startTick(){
  if (tickHandle) return;
  renderOnce(); // immediate
  tickHandle = setInterval(renderOnce, 1000);
}
function stopTick(){
  if (!tickHandle) return;
  clearInterval(tickHandle);
  tickHandle = null;
  // one last render for snapshot
  renderOnce();
}

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') startTick();
  else stopTick();
});

// initial behavior
if (document.visibilityState === 'visible') startTick();

// ---- optional: accept coords via ?lat=..&lon=.. ----
function getParams(){
  const p = {};
  try {
    const s = location.search.substring(1).split('&');
    s.forEach(kv=>{
      if(!kv) return;
      const [k,v] = kv.split('=');
      p[decodeURIComponent(k)] = decodeURIComponent(v || '');
    });
  } catch(e){}
  return p;
}

const params = getParams();
// If lat/lon given, you could compute sunrise/sunset client-side. For now we ignore if absent.
// If you want sunrise/sunset, either compute here or pass coords when opening the page.

document.getElementById('btn1').addEventListener('click', ()=>{ window.location.href = 'https://netan13.github.io/ctu/'; });
// Example: run a shortcut named "CTU Action" (may require URL-encoding)
document.getElementById('btn2').addEventListener('click', ()=>{ window.location.href = 'shortcuts://run-shortcut?name=' + encodeURIComponent('CTU Action'); });

</script>
</body>
</html>
