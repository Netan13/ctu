<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CTU — Watch</title>
    <style>
        html,body{height:100%;margin:0;background:#050505;color:#fff;font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", Helvetica, Arial;}
        .wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:10px;box-sizing:border-box;text-align:center;}
        .date{font-size:18px;font-weight:600;margin-bottom:6px;}
        .time{font-family:monospace;font-size:30px;font-weight:700;letter-spacing:0.02em;}
        .btns{position:absolute;right:8px;top:8px;display:flex;flex-direction:column;gap:8px;}
        button{background:rgba(255,255,255,0.08);border:0;padding:8px;border-radius:10px;color:#fff;font-size:14px;}
    </style>
</head>
<body>
<div class="wrap">
    <div class="date" id="ctu-date">— — —</div>
    <div class="time" id="ctu-time">--:--:-- CTU</div>
</div>

<div class="btns">
    <button id="btn1">Ouvrir site</button>
    <button id="btn2">Action</button>
</div>

<script>
    // ---- CTU logic (portage minimal du repo) ----
    const ORIGIN_UEC = 1486102.5;
    const LUNITIONS = ["Nuiron","Kelva","Drenae","Vellune","Rokel","Cereon","Elvora","Zailun","Aruel","Thylis","Velunor","Ombran","Siliane"];
    const NUIRON_DURATION = 11;
    const LUNITION_DURATION = 29;
    const SPINION_DURATION = 86400;

    function mod(a,n){ let r = a % n; return r < 0 ? r + n : r; }
    function toJulian(d){ return d.getTime()/86400000 - (d.getTimezoneOffset()/1440) + 2440587.5; }

    function elapsedDaysToSpinionLunitionOrbion(elapsedDays){
        let orbion = (elapsedDays / 365.2422);
        let spinionOfOrbion = mod(elapsedDays, 365.2422);
        let lunition, spinion;
        if (Math.abs(orbion) < 1e-12 && Math.abs(spinionOfOrbion) < 1e-12) {
            lunition = 1; spinion = 1;
        } else {
            if (orbion > 0) {
                if (spinionOfOrbion < NUIRON_DURATION) {
                    lunition = 0; spinion = spinionOfOrbion;
                } else {
                    spinionOfOrbion -= NUIRON_DURATION;
                    lunition = (spinionOfOrbion / LUNITION_DURATION) + 1;
                    spinion = spinionOfOrbion % LUNITION_DURATION;
                }
            } else {
                lunition = (spinionOfOrbion / LUNITION_DURATION) + 1;
                spinion = spinionOfOrbion % LUNITION_DURATION;
            }
            if (spinion === 0) spinion = 0; else spinion += 1;
        }
        spinion = Math.floor(spinion);
        lunition = Math.floor(lunition % 13);
        orbion = Math.floor(orbion);
        return { spinion, lunition, orbion };
    }

    function computeCTU(date){
        const jd = toJulian(date);
        const elapsedDays = jd - ORIGIN_UEC;
        const elapsedSeconds = elapsedDays * SPINION_DURATION;
        const {spinion, lunition, orbion} = elapsedDaysToSpinionLunitionOrbion(elapsedDays);
        const secondsToSpinion = mod(elapsedSeconds, SPINION_DURATION);
        const fraction = secondsToSpinion / SPINION_DURATION;

        // continuous values
        const spinor = Math.floor(fraction * 20);
        // minor and secor as continuous numbers (we keep fractional part for fluidity)
        const minorFloat = (fraction * 2000) % 100;      // 0..99.xx
        const secorFloat = (fraction * 200000) % 100;    // 0..99.xx

        return {
            spinion, lunition, orbion,
            spinor,
            minorFloat,
            secorFloat,
            secondsIntoSpinion: secondsToSpinion
        };
    }

    // ---- UI update with requestAnimationFrame ----
    const elDate = document.getElementById('ctu-date');
    const elTime = document.getElementById('ctu-time');
    let rafId = null;
    let running = false;

    function pad2(n){ return String(Math.floor(n)).padStart(2,'0'); }

    // Render one frame (uses continuous floats for fluidity)
    function renderOnce(){
        const now = new Date();
        const s = computeCTU(now);
        elDate.textContent = `${s.spinion} ${LUNITIONS[s.lunition]} ${s.orbion}`;

        // minor: integer, secor: integer + 2 decimals for smoothness
        const minorInt = Math.floor(s.minorFloat);
        const secorTotal = s.secorFloat; // e.g. 12.345...
        const secorInt = Math.floor(secorTotal);
        const secorFrac = Math.floor((secorTotal - secorInt) * 100); // two decimals

        elTime.textContent = `${pad2(s.spinor)}:${pad2(minorInt)}:${pad2(secorInt)}.${String(secorFrac).padStart(2,'0')} CTU`;
    }

    // animation loop
    function loop() {
        renderOnce();
        rafId = requestAnimationFrame(loop);
    }

    function startTick(){
        if (running) return;
        running = true;
        // one immediate render
        renderOnce();
        rafId = requestAnimationFrame(loop);
    }

    function stopTick(){
        if (!running) return;
        cancelAnimationFrame(rafId);
        rafId = null;
        running = false;
        // final static render for snapshot
        renderOnce();
    }

    // start/stop on visibility
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') startTick();
        else stopTick();
    });

    // initial behavior
    if (document.visibilityState === 'visible') startTick();
    else renderOnce();

    // buttons
    document.getElementById('btn1').addEventListener('click', ()=>{ window.location.href = 'https://netan13.github.io/ctu/'; });
    // example: run a shortcut named "CTU Action"
    document.getElementById('btn2').addEventListener('click', ()=>{ window.location.href = 'shortcuts://run-shortcut?name=' + encodeURIComponent('CTU Action'); });

</script>
</body>
</html>
